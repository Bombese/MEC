-- WindUI + Fly Behind Player (Tween Follow)

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- Settings
getgenv().FlySpeed = 60
getgenv().FollowDistance = 4
getgenv().IsFlying = false
getgenv().TargetPlayer = nil

-- Tween ไปยังตำแหน่ง
local function TweenTo(cf, speed)
    local char = player.Character or player.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")

    local dist = (cf.Position - hrp.Position).Magnitude
    local tween = TweenService:Create(
        hrp,
        TweenInfo.new(dist / speed, Enum.EasingStyle.Linear),
        {CFrame = cf}
    )
    tween:Play()
end

-- ดึงรายชื่อผู้เล่น
local function GetPlayerList()
    local list = {}
    for _,plr in pairs(Players:GetPlayers()) do
        if plr ~= player then
            table.insert(list, plr.Name)
        end
    end
    return list
end

-- Loop บินตามหลัง
RunService.Heartbeat:Connect(function()
    if getgenv().IsFlying and getgenv().TargetPlayer then
        local t = getgenv().TargetPlayer
        if t.Character and t.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = t.Character.HumanoidRootPart
            local behind = hrp.CFrame * CFrame.new(0, 0, getgenv().FollowDistance)
            TweenTo(behind, getgenv().FlySpeed)
        end
    end
end)

-- Load WindUI
local WindUI = loadstring(game:HttpGet(
    "https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"
))()

-- Window
local Window = WindUI:CreateWindow({
    Title = "NOOBHUB",
    Icon = "user",
    Author = "TEST",
    OpenButton = {
        Title = "Open UI",
        Icon = "monitor",
        Enabled = true,
        Draggable = true,
    }
})

-- Tab
local Tab = Window:Tab({
    Title = "Fly Player",
    Icon = "user",
})
Tab:Select()

-- Dropdown เลือกผู้เล่น
local PlayerDropdown = Tab:Dropdown({
    Title = "Select Player",
    Values = GetPlayerList(),
    Multi = false,
    Callback = function(name)
        getgenv().TargetPlayer = Players:FindFirstChild(name)
    end
})

-- ปุ่มเริ่มบิน
Tab:Button({
    Title = "Start Fly (Follow)",
    Callback = function()
        if getgenv().TargetPlayer then
            getgenv().IsFlying = true
        end
    end
})

-- ปุ่มหยุดบิน
Tab:Button({
    Title = "Stop Fly",
    Callback = function()
        getgenv().IsFlying = false
    end
})

-- Slider ปรับความเร็ว
Tab:Slider({
    Title = "Fly Speed",
    Step = 1,
    Value = {
        Min = 20,
        Max = 150,
        Default = getgenv().FlySpeed
    },
    Callback = function(v)
        getgenv().FlySpeed = v
    end
})

-- ปุ่มรีเฟรชรายชื่อผู้เล่น
Tab:Button({
    Title = "Refresh Player List",
    Callback = function()
        PlayerDropdown:SetValues(GetPlayerList())
    end
})
-- ===== PLAYER ESP (FULL / FIXED) =====

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local ESPEnabled = false
local ESPObjects = {}

-- ===== CREATE ESP =====
local function CreateESP(plr)
    if plr == LocalPlayer then return end
    if not plr.Character or not plr.Character:FindFirstChild("Head") then return end
    if ESPObjects[plr] then return end

    local bill = Instance.new("BillboardGui")
    bill.Name = "PlayerESP"
    bill.AlwaysOnTop = true
    bill.Size = UDim2.new(0, 120, 0, 25) -- ขนาดกรอบ
    bill.StudsOffset = Vector3.new(0, 2.5, 0)
    bill.Adornee = plr.Character.Head
    bill.Parent = plr.Character

    local text = Instance.new("TextLabel")
    text.Size = UDim2.new(1, 0, 1, 0)
    text.BackgroundTransparency = 1
    text.Text = plr.Name
    text.TextColor3 = Color3.fromRGB(255, 80, 80)
    text.TextStrokeTransparency = 0.3
    text.TextScaled = false        -- ❌ ปิด scaled
    text.TextSize = 14             -- ✅ ขนาดพอดี
    text.Font = Enum.Font.GothamBold
    text.Parent = bill

    ESPObjects[plr] = bill
end

-- ===== REMOVE ESP =====
local function RemoveESP()
    for _,esp in pairs(ESPObjects) do
        if esp then esp:Destroy() end
    end
    ESPObjects = {}
end

-- ===== ENABLE ESP =====
local function EnableESP()
    ESPEnabled = true
    for _,plr in pairs(Players:GetPlayers()) do
        CreateESP(plr)
    end
end

-- ===== DISABLE ESP =====
local function DisableESP()
    ESPEnabled = false
    RemoveESP()
end

-- ===== PLAYER JOIN =====
Players.PlayerAdded:Connect(function(plr)
    if ESPEnabled then
        plr.CharacterAdded:Connect(function()
            task.wait(1)
            CreateESP(plr)
        end)
    end
end)

-- ===== PLAYER RESPAWN =====
Players.PlayerRemoving:Connect(function(plr)
    if ESPObjects[plr] then
        ESPObjects[plr] = nil
    end
end)

-- ===== UI TAB (WINDUI) =====
local ESPTab = Window:Tab({
    Title = "ESP",
    Icon = "eye",
})

ESPTab:Button({
    Title = "ESP ON",
    Callback = function()
        EnableESP()
    end
})

ESPTab:Button({
    Title = "ESP OFF",
    Callback = function()
        DisableESP()
    end
})