-- WindUI + Fly Behind Player (Tween Follow)

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- Settings
getgenv().FlySpeed = 60
getgenv().FollowDistance = 4
getgenv().IsFlying = false
getgenv().TargetPlayer = nil

-- Tween ไปยังตำแหน่ง
local function TweenTo(cf, speed)
    local char = player.Character or player.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")

    local dist = (cf.Position - hrp.Position).Magnitude
    local tween = TweenService:Create(
        hrp,
        TweenInfo.new(dist / speed, Enum.EasingStyle.Linear),
        {CFrame = cf}
    )
    tween:Play()
end

-- ดึงรายชื่อผู้เล่น
local function GetPlayerList()
    local list = {}
    for _,plr in pairs(Players:GetPlayers()) do
        if plr ~= player then
            table.insert(list, plr.Name)
        end
    end
    return list
end

-- Loop บินตามหลัง
RunService.Heartbeat:Connect(function()
    if getgenv().IsFlying and getgenv().TargetPlayer then
        local t = getgenv().TargetPlayer
        if t.Character and t.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = t.Character.HumanoidRootPart
            local behind = hrp.CFrame * CFrame.new(0, 0, getgenv().FollowDistance)
            TweenTo(behind, getgenv().FlySpeed)
        end
    end
end)

-- Load WindUI
local WindUI = loadstring(game:HttpGet(
    "https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"
))()

-- Window
local Window = WindUI:CreateWindow({
    Title = "NOOBHUB",
    Icon = "user",
    Author = "TEST",
    OpenButton = {
        Title = "Open UI",
        Icon = "monitor",
        Enabled = true,
        Draggable = true,
    }
})

-- Tab
local Tab = Window:Tab({
    Title = "Fly Player",
    Icon = "user",
})
Tab:Select()

-- Dropdown เลือกผู้เล่น
local PlayerDropdown = Tab:Dropdown({
    Title = "Select Player",
    Values = GetPlayerList(),
    Multi = false,
    Callback = function(name)
        getgenv().TargetPlayer = Players:FindFirstChild(name)
    end
})

-- ปุ่มเริ่มบิน
Tab:Button({
    Title = "Start Fly (Follow)",
    Callback = function()
        if getgenv().TargetPlayer then
            getgenv().IsFlying = true
        end
    end
})

-- ปุ่มหยุดบิน
Tab:Button({
    Title = "Stop Fly",
    Callback = function()
        getgenv().IsFlying = false
    end
})

-- Slider ปรับความเร็ว
Tab:Slider({
    Title = "Fly Speed",
    Step = 1,
    Value = {
        Min = 20,
        Max = 150,
        Default = getgenv().FlySpeed
    },
    Callback = function(v)
        getgenv().FlySpeed = v
    end
})

-- ปุ่มรีเฟรชรายชื่อผู้เล่น
Tab:Button({
    Title = "Refresh Player List",
    Callback = function()
        PlayerDropdown:SetValues(GetPlayerList())
    end
})
-- ===== PLAYER ESP (FULL / FIXED) =====

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local ESPEnabled = false
local ESPObjects = {}

-- ===== CREATE ESP =====
local function CreateESP(plr)
    if plr == LocalPlayer then return end
    if not plr.Character or not plr.Character:FindFirstChild("Head") then return end
    if ESPObjects[plr] then return end

    local bill = Instance.new("BillboardGui")
    bill.Name = "PlayerESP"
    bill.AlwaysOnTop = true
    bill.Size = UDim2.new(0, 120, 0, 25) -- ขนาดกรอบ
    bill.StudsOffset = Vector3.new(0, 2.5, 0)
    bill.Adornee = plr.Character.Head
    bill.Parent = plr.Character

    local text = Instance.new("TextLabel")
    text.Size = UDim2.new(1, 0, 1, 0)
    text.BackgroundTransparency = 1
    text.Text = plr.Name
    text.TextColor3 = Color3.fromRGB(255, 80, 80)
    text.TextStrokeTransparency = 0.3
    text.TextScaled = false        -- ❌ ปิด scaled
    text.TextSize = 14             -- ✅ ขนาดพอดี
    text.Font = Enum.Font.GothamBold
    text.Parent = bill

    ESPObjects[plr] = bill
end

-- ===== REMOVE ESP =====
local function RemoveESP()
    for _,esp in pairs(ESPObjects) do
        if esp then esp:Destroy() end
    end
    ESPObjects = {}
end

-- ===== ENABLE ESP =====
local function EnableESP()
    ESPEnabled = true
    for _,plr in pairs(Players:GetPlayers()) do
        CreateESP(plr)
    end
end

-- ===== DISABLE ESP =====
local function DisableESP()
    ESPEnabled = false
    RemoveESP()
end

-- ===== PLAYER JOIN =====
Players.PlayerAdded:Connect(function(plr)
    if ESPEnabled then
        plr.CharacterAdded:Connect(function()
            task.wait(1)
            CreateESP(plr)
        end)
    end
end)

-- ===== PLAYER RESPAWN =====
Players.PlayerRemoving:Connect(function(plr)
    if ESPObjects[plr] then
        ESPObjects[plr] = nil
    end
end)

-- ===== UI TAB (WINDUI) =====
local ESPTab = Window:Tab({
    Title = "ESP",
    Icon = "eye",
})

ESPTab:Button({
    Title = "ESP ON",
    Callback = function()
        EnableESP()
    end
})

ESPTab:Button({
    Title = "ESP OFF",
    Callback = function()
        DisableESP()
    end
})
-- ===== HACK SYSTEM =====

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer

-- Settings
getgenv().WalkSpeedValue = 16
getgenv().InfJump = false
getgenv().Noclip = false

-- Character helper
local function GetChar()
    local char = player.Character or player.CharacterAdded:Wait()
    return char, char:WaitForChild("Humanoid"), char:WaitForChild("HumanoidRootPart")
end

-- ===== WALKSPEED LOOP =====
RunService.RenderStepped:Connect(function()
    local char, hum = GetChar()
    if hum and hum.WalkSpeed ~= getgenv().WalkSpeedValue then
        hum.WalkSpeed = getgenv().WalkSpeedValue
    end
end)

-- ===== INFINITE JUMP =====
UserInputService.JumpRequest:Connect(function()
    if getgenv().InfJump then
        local char, hum = GetChar()
        if hum then
            hum:ChangeState(Enum.HumanoidStateType.Jumping)
        end
    end
end)

-- ===== NOCLIP =====
RunService.Stepped:Connect(function()
    if getgenv().Noclip then
        local char = player.Character
        if char then
            for _,v in pairs(char:GetDescendants()) do
                if v:IsA("BasePart") then
                    v.CanCollide = false
                end
            end
        end
    end
end)

-- ===== UI : HACK TAB =====
local HackTab = Window:Tab({
    Title = "Hack",
    Icon = "zap",
})
HackTab:Select()

-- WalkSpeed Slider
HackTab:Slider({
    Title = "Walk Speed",
    Desc = "ปรับความเร็วการเดิน",
    Step = 1,
    Value = {
        Min = 16,
        Max = 200,
        Default = getgenv().WalkSpeedValue
    },
    Callback = function(v)
        getgenv().WalkSpeedValue = v
    end
})

-- Infinite Jump Toggle
HackTab:Toggle({
    Title = "Infinite Jump",
    Desc = "กระโดดไม่จำกัด",
    Value = false,
    Callback = function(v)
        getgenv().InfJump = v
    end
})

-- Noclip Toggle
HackTab:Toggle({
    Title = "Noclip",
    Desc = "เดินทะลุกำแพง",
    Value = false,
    Callback = function(v)
        getgenv().Noclip = v
    end
})
-- ===== SEMI INVISIBLE MODE =====

getgenv().SemiInvisible = false

local Players = game:GetService("Players")
local player = Players.LocalPlayer

local function SetSemiInvisible(state)
    local char = player.Character
    if not char then return end

    for _,v in pairs(char:GetDescendants()) do
        -- ส่วนร่างกาย
        if v:IsA("BasePart") then
            if v.Name ~= "HumanoidRootPart" then
                v.Transparency = state and 0.75 or 0
                v.CanCollide = not state
            end
        end

        -- หน้าตัวละคร
        if v:IsA("Decal") then
            v.Transparency = state and 0.9 or 0
        end

        -- ชื่อบนหัว
        if v:IsA("BillboardGui") then
            v.Enabled = not state
        end
    end
end

-- กันตายแล้วโหมดหาย
player.CharacterAdded:Connect(function()
    task.wait(1)
    if getgenv().SemiInvisible then
        SetSemiInvisible(true)
    end
end)

-- ===== UI : ADD TO HACK TAB =====
HackTab:Toggle({
    Title = "Semi Invisible",
    Desc = "โปร่งใส (คนอื่นเห็นยาก)",
    Value = false,
    Callback = function(v)
        getgenv().SemiInvisible = v
        SetSemiInvisible(v)
    end
})
-- ===== SKELETON ESP (R6 + R15) =====

getgenv().SkeletonESP = false

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local Skeletons = {}

-- ===== Bones =====

local BonesR15 = {
    {"Head","UpperTorso"},
    {"UpperTorso","LowerTorso"},

    {"UpperTorso","LeftUpperArm"},
    {"LeftUpperArm","LeftLowerArm"},
    {"LeftLowerArm","LeftHand"},

    {"UpperTorso","RightUpperArm"},
    {"RightUpperArm","RightLowerArm"},
    {"RightLowerArm","RightHand"},

    {"LowerTorso","LeftUpperLeg"},
    {"LeftUpperLeg","LeftLowerLeg"},
    {"LeftLowerLeg","LeftFoot"},

    {"LowerTorso","RightUpperLeg"},
    {"RightUpperLeg","RightLowerLeg"},
    {"RightLowerLeg","RightFoot"},
}

local BonesR6 = {
    {"Head","Torso"},

    {"Torso","Left Arm"},
    {"Torso","Right Arm"},

    {"Torso","Left Leg"},
    {"Torso","Right Leg"},
}

-- ===== Functions =====

local function ClearSkeleton(plr)
    if Skeletons[plr] then
        for _,line in pairs(Skeletons[plr]) do
            line:Remove()
        end
        Skeletons[plr] = nil
    end
end

local function CreateSkeleton(plr, bones)
    Skeletons[plr] = {}

    for _ = 1,#bones do
        local line = Drawing.new("Line")
        line.Thickness = 1.5
        line.Color = Color3.fromRGB(0,255,170)
        line.Transparency = 1
        line.Visible = false
        table.insert(Skeletons[plr], line)
    end
end

-- ===== Render =====

RunService.RenderStepped:Connect(function()
    if not getgenv().SkeletonESP then
        for _,plr in pairs(Players:GetPlayers()) do
            ClearSkeleton(plr)
        end
        return
    end

    for _,plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local char = plr.Character
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if not humanoid then continue end

            local bones = humanoid.RigType == Enum.HumanoidRigType.R15 and BonesR15 or BonesR6

            if not Skeletons[plr] then
                CreateSkeleton(plr, bones)
            end

            for i,bone in ipairs(bones) do
                local p1 = char:FindFirstChild(bone[1])
                local p2 = char:FindFirstChild(bone[2])
                local line = Skeletons[plr][i]

                if p1 and p2 then
                    local s1,v1 = Camera:WorldToViewportPoint(p1.Position)
                    local s2,v2 = Camera:WorldToViewportPoint(p2.Position)

                    if v1 and v2 then
                        line.From = Vector2.new(s1.X,s1.Y)
                        line.To   = Vector2.new(s2.X,s2.Y)
                        line.Visible = true
                    else
                        line.Visible = false
                    end
                else
                    line.Visible = false
                end
            end
        end
    end
end)

-- ===== UI =====
HackTab:Toggle({
    Title = "Skeleton ESP (R6 / R15)",
    Desc = "รองรับผู้เล่นทุก Rig",
    Value = false,
    Callback = function(v)
        getgenv().SkeletonESP = v
    end
})
-- ===== OTHERS TAB (SPECTATE + TP INSTANT) =====

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

getgenv().SelectedPlayer = nil

-- ===== PLAYER LIST =====
local PlayerList = {}

local function RefreshPlayers()
    table.clear(PlayerList)
    for _,p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            table.insert(PlayerList, p.Name)
        end
    end
end

RefreshPlayers()
Players.PlayerAdded:Connect(RefreshPlayers)
Players.PlayerRemoving:Connect(RefreshPlayers)

-- ===== SPECTATE =====
local function Spectate(plr)
    if plr and plr.Character and plr.Character:FindFirstChild("Humanoid") then
        Camera.CameraSubject = plr.Character.Humanoid
    end
end

local function UnSpectate()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        Camera.CameraSubject = LocalPlayer.Character.Humanoid
    end
end

-- ===== TP INSTANT =====
local function TPToPlayer(plr)
    if plr and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.CFrame =
            plr.Character.HumanoidRootPart.CFrame * CFrame.new(0, 0, -3)
    end
end

-- ===== UI TAB =====
local OtherTab = Window:Tab({
    Title = "Others",
    Icon = "eye",
})

OtherTab:Dropdown({
    Title = "เลือกผู้เล่น",
    Values = PlayerList,
    Value = nil,
    Multi = false,
    Callback = function(v)
        getgenv().SelectedPlayer = Players:FindFirstChild(v)
    end
})

OtherTab:Button({
    Title = "ดูมุมมองผู้เล่น",
    Callback = function()
        if getgenv().SelectedPlayer then
            Spectate(getgenv().SelectedPlayer)
        end
    end
})

OtherTab:Button({
    Title = "กลับมามุมมองเรา",
    Callback = function()
        UnSpectate()
    end
})

OtherTab:Button({
    Title = "TP ไปหาผู้เล่น (ทันที)",
    Callback = function()
        if getgenv().SelectedPlayer then
            TPToPlayer(getgenv().SelectedPlayer)
        end
    end
})
-- ===== UTILITY TAB =====

local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer
local PlaceId = game.PlaceId

-- ===== REJOIN =====
local function RejoinServer()
    TeleportService:Teleport(PlaceId, LocalPlayer)
end

-- ===== SERVER HOP =====
local function ServerHop()
    local url = "https://games.roblox.com/v1/games/"..PlaceId.."/servers/Public?sortOrder=Asc&limit=100"
    local body = game:HttpGet(url)
    local data = HttpService:JSONDecode(body)

    local servers = {}

    for _,v in pairs(data.data) do
        if v.playing < v.maxPlayers and v.id ~= game.JobId then
            table.insert(servers, v.id)
        end
    end

    if #servers > 0 then
        TeleportService:TeleportToPlaceInstance(PlaceId, servers[math.random(1,#servers)], LocalPlayer)
    end
end

-- ===== UI TAB =====
local UtilityTab = Window:Tab({
    Title = "Utility",
    Icon = "settings",
})

UtilityTab:Button({
    Title = "Rejoin Server",
    Desc = "ออกแล้วเข้าเซิร์ฟเดิมใหม่",
    Callback = function()
        RejoinServer()
    end
})

UtilityTab:Button({
    Title = "Server Hop",
    Desc = "ย้ายไปเซิร์ฟอื่นแบบสุ่ม",
    Callback = function()
        ServerHop()
    end
})
-- ===== SETTINGS TAB =====

local SettingsTab = Window:Tab({
    Title = "Setting",
    Icon = "settings",
})

-- ===== DEV INFO =====
SettingsTab:Label({
    Title = "Developer",
    Desc = "Bom Bom",
})

-- ===== DISCORD COPY =====
SettingsTab:Button({
    Title = "Discord",
    Desc = "กดเพื่อคัดลอก Discord",
    Callback = function()
        if setclipboard then
            setclipboard("discord.gg/5d6W4wuTdR")
        end
    end
})